# [如何写一个 PostgreSQL Extension](https://github.com/yihong0618/gitblog/issues/270)

## 什么是 PostgreSQL Extension

PostgreSQL Extension 是一个可插拔的功能扩展，用于在 PostgreSQL 数据库系统中添加额外的功能和能力。这些扩展可以由第三方开发者开发并加入到 PostgreSQL 中，以满足特定的需求。扩展可以增强数据库功能。
有些非常不错的 Extensions 甚至成了一些公司选型 Postgres 的理由比如：[TimescaleDB](https://www.timescale.com/blog/top-5-postgresql-extensions/#1-timescaledb), [PostGIS](https://www.timescale.com/blog/top-5-postgresql-extensions/#2-postgis) 等等。

今年开始异常火爆的向量数据库，因为有 [pgvector](https://github.com/pgvector/pgvector) 也让 pg 有了向量计算和存储的能力。

**本文会介绍如何编写 extensions 和推荐一系列编写 Extensions 的资源。**

## 如何写一个 Extensions

传统的 extensions 开发一般情况下我们会 c 语言，引入 `Postgers.h` 写好 Makefile 和 SQL 开发，现在也有了用 Rust 编写 Extensions 的能力 -> [pgrx](https://github.com/pgcentralfoundation/pgrx)  借助 pgrx 我们能更好的专注 extensions 中算法本身，也可以借助 Rust 强大的生态更容易的编写 extensions 需要的逻辑，进行更快速，更安全的开发。

下文，会分别介绍 C 和 Rust 两种开发方式。

### C 语言开发 Extensions

> 可以参考这篇文章 -> [PostgreSQL插件开发](https://csblog.cc/dbnotes/PostgreSQL%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91.html)

以 hello_world 为例，需要在 hello_world 文件夹中建下面 4 个文件

```
hello.control         # 插件名.control
hello.c                   # 插件名.c
hello--1.0.sql        # 插件名--1.0.sql
Makefile                # 用于编译
```

```
cat hello.control
comment = 'hello:'
default_version = '1.0'
module_pathname = '$libdir/hello'
relocatable = false
superuser = true
```
剩下的可以参考这个 pg 的 hello_world 项目 https://github.com/magnusp/pg_hello

```c
// cat pg_hello.c
#include "postgres.h"

#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

Datum hello( PG_FUNCTION_ARGS );

PG_FUNCTION_INFO_V1( hello );
Datum
hello( PG_FUNCTION_ARGS )
{
   // variable declarations
   char greet[] = "Hello, ";
   text *towhom;
   int greetlen;
   int towhomlen;
   text *greeting;

   // Get arguments.  If we declare our function as STRICT, then
   // this check is superfluous.
   if( PG_ARGISNULL(0) ) {
      PG_RETURN_NULL();
   }
   towhom = PG_GETARG_TEXT_P(0);

   // Calculate string sizes.
   greetlen = strlen(greet);
   towhomlen = VARSIZE(towhom) - VARHDRSZ;

   // Allocate memory and set data structure size.
   greeting = (text *)palloc( greetlen + towhomlen );
   SET_VARSIZE(greeting, greetlen + towhomlen  + VARHDRSZ);

   // Construct greeting string.
   strncpy( VARDATA(greeting), greet, greetlen );
   strncpy( VARDATA(greeting) + greetlen,
            VARDATA(towhom),
            towhomlen );

   PG_RETURN_TEXT_P( greeting );
}
```

代码的一些解释：

1. `#include "postgres.h"` 包含了大部分编写 postgres 相关程序需要的东西，每个 extensions 必须包含这个
2. `#include "fmgr.h"` 则包含了PG_GETARG_XXX、PG_RETURN_XXX和PG_ARGISNULL 等编写 extensions 必要的宏
3.  Datum 是 data 的单数是在 pg 中最重要的数据类型之一，它肩负着在PG 内核与用户代码之间传递数据的责任
4. PG_MODULE_MAGIC 这个宏是编写 extensions 的一个必要的宏为了后面编译生成的库才可以被 postgresql 加载

在这之后就可以编写好 Makefile 把 pg 的 PATH 加入到环境变量中之后 make && make install

在这之后进入到 psql, create extension hello; select hello('hello'); 就可以了


![Uploading image.png…]()
